name: Release VB6 Web Compiler

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # VALIDATION & PRE-RELEASE CHECKS
  # ============================================================================
  validate-release:
    name: ğŸ” Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      changelog: ${{ steps.get-changelog.outputs.changelog }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: ğŸ“‹ Get changelog
        id: get-changelog
        run: |
          if [ -f "CHANGELOG.md" ]; then
            # Extract changelog for this version
            CHANGELOG=$(sed -n "/## \[${{ steps.get-version.outputs.version }}\]/,/## \[/p" CHANGELOG.md | head -n -1)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changelog entry found for ${{ steps.get-version.outputs.version }}"
            fi
          else
            CHANGELOG="Changelog not available"
          fi

          # Save changelog to file for multi-line output
          echo "$CHANGELOG" > changelog.txt
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: âœ… Validate version format
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: v1.2.3 or v1.2.3-alpha"
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run all tests
        run: |
          npm test
          npm run test:integration || echo "Integration tests not available"
        env:
          CI: true

      - name: ğŸ“Š Run compatibility validation
        run: |
          npm test -- src/test/compatibility/VB6CompatibilityTests.ts
        env:
          RELEASE_VALIDATION: true

      - name: ğŸ“ˆ Run performance benchmarks
        run: |
          npm test -- src/test/benchmarks/VB6NativeBenchmarks.ts
        env:
          BENCHMARK_MODE: true

  # ============================================================================
  # BUILD RELEASE ARTIFACTS
  # ============================================================================
  build-release:
    name: ğŸ—ï¸ Build Release
    runs-on: ${{ matrix.os }}
    needs: validate-release

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: windows-latest
            platform: win32
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: x64

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
          GENERATE_SOURCEMAP: false
          PUBLIC_VERSION: ${{ needs.validate-release.outputs.version }}

      - name: ğŸ—ï¸ Build server
        run: |
          cd server
          npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“¦ Package application
        run: |
          mkdir -p release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}

          # Copy build artifacts
          cp -r dist/* release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/

          # Copy server artifacts  
          mkdir -p release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/server
          cp -r server/dist/* release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/server/ || true

          # Copy runtime files
          if [ -d "src/runtime" ]; then
            cp -r src/runtime release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/
          fi

          # Copy documentation
          cp README.md release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/
          cp LICENSE release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/ || echo "No LICENSE file"
          cp CHANGELOG.md release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/ || echo "No CHANGELOG file"

          # Copy package.json (without dev dependencies)
          node -e "
            const pkg = require('./package.json');
            delete pkg.devDependencies;
            delete pkg.scripts.dev;
            delete pkg.scripts.test;
            require('fs').writeFileSync(
              'release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/package.json',
              JSON.stringify(pkg, null, 2)
            );
          "

          # Create installation script
          cat > release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/install.sh << 'EOF'
          #!/bin/bash
          echo "Installing VB6 Web Compiler ${{ needs.validate-release.outputs.version }}"
          npm install --production
          echo "Installation complete!"
          echo "Run 'npm start' to start the application"
          EOF
          chmod +x release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}/install.sh

      - name: ğŸ“¦ Create archive
        run: |
          cd release
          if [ "${{ matrix.platform }}" == "win32" ]; then
            powershell Compress-Archive -Path "vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}" -DestinationPath "vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}.zip"
          else
            tar -czf vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}
          fi
        shell: bash

      - name: ğŸ” Verify package
        run: |
          cd release
          echo "Package contents:"
          if [ "${{ matrix.platform }}" == "win32" ]; then
            powershell Get-ChildItem -Recurse vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}
          else
            find vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }} -type f | head -20
          fi
        shell: bash

      - name: ğŸ“¤ Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            release/vb6-web-compiler-${{ needs.validate-release.outputs.version }}-${{ matrix.platform }}-${{ matrix.arch }}.*
          retention-days: 30

  # ============================================================================
  # BUILD NPM PACKAGE
  # ============================================================================
  build-npm:
    name: ğŸ“¦ Build NPM Package
    runs-on: ubuntu-latest
    needs: validate-release

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build package
        run: |
          npm run build:npm || npm run build
          npm pack

      - name: ğŸ“¤ Upload NPM package
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: '*.tgz'
          retention-days: 30

  # ============================================================================
  # BUILD DOCKER IMAGES
  # ============================================================================
  build-docker:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: validate-release

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to Docker Hub
        if: env.DOCKER_HUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}

      - name: ğŸ”‘ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            vb6web/compiler
            ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.validate-release.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # CREATE GITHUB RELEASE
  # ============================================================================
  create-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-release, build-npm, build-docker]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ğŸ“‹ Generate release notes
        run: |
          echo "# VB6 Web Compiler ${{ needs.validate-release.outputs.version }}" > release_notes.md
          echo "" >> release_notes.md
          echo "${{ needs.validate-release.outputs.changelog }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸ“¦ Downloads" >> release_notes.md
          echo "" >> release_notes.md

          # List platform-specific downloads
          for file in artifacts/release-*/vb6-web-compiler-*; do
            if [ -f "$file" ]; then
              basename=$(basename "$file")
              echo "- [$basename]($file)" >> release_notes.md
            fi
          done

          echo "" >> release_notes.md
          echo "## ğŸ³ Docker Images" >> release_notes.md
          echo "" >> release_notes.md
          echo "- \`docker pull vb6web/compiler:${{ needs.validate-release.outputs.version }}\`" >> release_notes.md
          echo "- \`docker pull ghcr.io/${{ github.repository }}:${{ needs.validate-release.outputs.version }}\`" >> release_notes.md

          echo "" >> release_notes.md
          echo "## ğŸ“¦ NPM Package" >> release_notes.md
          echo "" >> release_notes.md
          echo "- \`npm install @vb6web/compiler@${{ needs.validate-release.outputs.version }}\`" >> release_notes.md

          echo "" >> release_notes.md
          echo "## ğŸ”— Links" >> release_notes.md
          echo "" >> release_notes.md
          echo "- [Documentation](https://docs.vb6web.com)" >> release_notes.md
          echo "- [API Reference](https://api.vb6web.com)" >> release_notes.md
          echo "- [Migration Guide](https://docs.vb6web.com/migration)" >> release_notes.md

          cat release_notes.md

      - name: ğŸš€ Create Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          release_name: VB6 Web Compiler ${{ needs.validate-release.outputs.version }}
          body_path: release_notes.md
          draft: ${{ inputs.draft || false }}
          prerelease: ${{ inputs.prerelease || contains(needs.validate-release.outputs.version, '-') }}

      - name: ğŸ“¤ Upload Release Assets
        run: |
          for file in artifacts/release-*/*; do
            if [ -f "$file" ]; then
              echo "Uploading $file"
              curl -L \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                -H "Content-Type: application/octet-stream" \
                "${{ steps.create_release.outputs.upload_url }}?name=$(basename "$file")" \
                --data-binary @"$file"
            fi
          done

          # Upload NPM package
          for file in artifacts/npm-package/*; do
            if [ -f "$file" ]; then
              echo "Uploading NPM package $file"
              curl -L \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                -H "Content-Type: application/gzip" \
                "${{ steps.create_release.outputs.upload_url }}?name=$(basename "$file")" \
                --data-binary @"$file"
            fi
          done

  # ============================================================================
  # PUBLISH NPM PACKAGE
  # ============================================================================
  publish-npm:
    name: ğŸ“¦ Publish to NPM
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: ${{ !inputs.prerelease && !contains(needs.validate-release.outputs.version, '-') }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build package
        run: npm run build:npm || npm run build

      - name: ğŸ“¦ Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============================================================================
  # POST-RELEASE TASKS
  # ============================================================================
  post-release:
    name: ğŸ“‹ Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¢ Update documentation
        run: |
          # Update version in documentation
          if [ -f "docs/README.md" ]; then
            sed -i "s/Version: .*/Version: ${{ needs.validate-release.outputs.version }}/" docs/README.md
          fi

          # Update version in package.json examples
          find docs/ -name "*.md" -exec sed -i "s/@vb6web\/compiler@[^\"]*/@vb6web\/compiler@${{ needs.validate-release.outputs.version }}/g" {} \;

      - name: ğŸ“§ Notify team
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#releases'
          text: |
            ğŸš€ VB6 Web Compiler ${{ needs.validate-release.outputs.version }} Released!

            ğŸ“¦ Available on NPM, Docker Hub, and GitHub Releases
            ğŸ”— Release Notes: ${{ steps.create_release.outputs.html_url }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“ Create next version milestone
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.validate-release.outputs.version }}';
            const versionMatch = version.match(/v(\d+)\.(\d+)\.(\d+)/);

            if (versionMatch) {
              const major = parseInt(versionMatch[1]);
              const minor = parseInt(versionMatch[2]);
              const patch = parseInt(versionMatch[3]);
              
              const nextVersion = `v${major}.${minor}.${patch + 1}`;
              
              try {
                await github.rest.issues.createMilestone({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: nextVersion,
                  description: `Next patch release after ${version}`,
                  state: 'open'
                });
                console.log(`Created milestone for ${nextVersion}`);
              } catch (error) {
                console.log(`Milestone ${nextVersion} might already exist`);
              }
            }

# ============================================================================
# CLEANUP
# ============================================================================
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false
