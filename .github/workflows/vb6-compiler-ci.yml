name: VB6 Web Compiler CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'server/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vitest.config.ts'
      - 'vite.config.ts'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'server/**'
      - 'package.json'
      - 'package-lock.json'

env:
  NODE_VERSION: '18'
  CACHE_VERSION: v1

jobs:
  # ============================================================================
  # SETUP & VALIDATION
  # ============================================================================
  setup:
    name: ğŸ”§ Setup & Validate
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      should-deploy: ${{ steps.check-deploy.outputs.should-deploy }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better caching

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: ğŸ”‘ Generate cache key
        id: cache-key
        run: |
          echo "key=${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}-${{ env.CACHE_VERSION }}" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            server/node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: ğŸ“¥ Install root dependencies
        run: npm ci --ignore-scripts

      - name: ğŸ“¥ Install server dependencies
        run: |
          cd server
          npm ci --ignore-scripts

      - name: âœ… Validate package.json files
        run: |
          npm run validate-package || echo "Package validation script not found, skipping"
          cd server && npm run validate-package || echo "Server package validation script not found, skipping"

      - name: ğŸš€ Check if should deploy
        id: check-deploy
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # CODE QUALITY & LINTING
  # ============================================================================
  lint:
    name: ğŸ§¹ Lint & Format
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            server/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci --ignore-scripts
          cd server && npm ci --ignore-scripts

      - name: ğŸ§¹ Run ESLint
        run: |
          npm run lint
          cd server && npm run lint || echo "Server lint not available"

      - name: ğŸ’… Check Prettier formatting
        run: |
          npm run format:check

      - name: ğŸ” TypeScript type checking
        run: |
          npm run type-check || npx tsc --noEmit
          cd server && npm run type-check || npx tsc --noEmit

  # ============================================================================
  # VB6 COMPILER TESTS
  # ============================================================================
  test-compiler:
    name: ğŸ§ª VB6 Compiler Tests
    runs-on: ubuntu-latest
    needs: setup

    strategy:
      matrix:
        test-suite: [unit, integration, compatibility, benchmarks]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            server/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ğŸ“¥ Install dependencies
        run: npm ci --ignore-scripts

      - name: ğŸ§ª Run ${{ matrix.test-suite }} tests
        run: |
          case "${{ matrix.test-suite }}" in
            unit)
              npm test -- src/test/services/VB6Compiler.test.ts src/test/utils/
              ;;
            integration)
              npm test -- src/test/compiler/VB6CompilerIntegrationTests.ts
              ;;
            compatibility)
              npm test -- src/test/compatibility/VB6CompatibilityTests.ts
              ;;
            benchmarks)
              npm test -- src/test/benchmarks/VB6NativeBenchmarks.ts
              ;;
          esac
        env:
          NODE_ENV: test
          CI: true

      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            coverage/
            test-results/
          retention-days: 30

      - name: ğŸ“ˆ Generate test report
        if: matrix.test-suite == 'compatibility'
        run: |
          npm run test:report || echo "Test report generation not available"

      - name: ğŸ† Upload compatibility report
        if: matrix.test-suite == 'compatibility'
        uses: actions/upload-artifact@v4
        with:
          name: vb6-compatibility-report
          path: reports/compatibility-report.html
          retention-days: 90

  # ============================================================================
  # PERFORMANCE BENCHMARKING
  # ============================================================================
  benchmark:
    name: ğŸ“ˆ Performance Benchmarks
    runs-on: ubuntu-latest
    needs: setup
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci --ignore-scripts

      - name: ğŸš€ Run performance benchmarks
        run: |
          npm run benchmark || npm test -- src/test/benchmarks/
        env:
          NODE_ENV: production
          BENCHMARK_MODE: true

      - name: ğŸ“Š Generate benchmark report
        run: |
          npm run benchmark:report || echo "Benchmark report generation not available"

      - name: ğŸ“ˆ Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: performance-benchmarks
          path: |
            reports/benchmark-report.html
            reports/benchmark-data.json
          retention-days: 90

      - name: ğŸ’¬ Comment benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('reports/benchmark-data.json')) {
              const benchmarkData = JSON.parse(fs.readFileSync('reports/benchmark-data.json', 'utf8'));
              const comment = `
              ## ğŸ“ˆ Performance Benchmark Results
              
              | Category | Average Ratio | Status |
              |----------|---------------|---------|
              | String Operations | ${benchmarkData.stringOps || 'N/A'} | ${benchmarkData.stringOps < 2.0 ? 'âœ…' : 'âš ï¸'} |
              | Math Operations | ${benchmarkData.mathOps || 'N/A'} | ${benchmarkData.mathOps < 1.5 ? 'âœ…' : 'âš ï¸'} |
              | Array Operations | ${benchmarkData.arrayOps || 'N/A'} | ${benchmarkData.arrayOps < 2.5 ? 'âœ…' : 'âš ï¸'} |
              
              **Overall Performance**: ${benchmarkData.overallRatio || 'N/A'}x vs VB6 Native
              **Grade**: ${benchmarkData.grade || 'N/A'}
              
              Target: <2.0x slower than VB6 native
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # ============================================================================
  # BUILD & PACKAGING
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [setup, lint, test-compiler]

    strategy:
      matrix:
        target: [development, production]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: ğŸ—ï¸ Build application (${{ matrix.target }})
        run: |
          if [ "${{ matrix.target }}" == "production" ]; then
            npm run build
          else
            npm run build:dev
          fi
        env:
          NODE_ENV: ${{ matrix.target }}
          GENERATE_SOURCEMAP: ${{ matrix.target == 'development' && 'true' || 'false' }}

      - name: ğŸ“ Enforce bundle budget (production only)
        if: matrix.target == 'production'
        run: npm run budget:check

      - name: ğŸ—ï¸ Build server (${{ matrix.target }})
        run: |
          cd server
          if [ "${{ matrix.target }}" == "production" ]; then
            npm run build
          else
            npm run build:dev || npm run build
          fi

      - name: ğŸ“¦ Package artifacts
        run: |
          mkdir -p artifacts/${{ matrix.target }}
          cp -r dist/* artifacts/${{ matrix.target }}/
          cp -r server/dist artifacts/${{ matrix.target }}/server/ || mkdir -p artifacts/${{ matrix.target }}/server/

          # Package runtime files
          if [ -d "src/runtime" ]; then
            cp -r src/runtime artifacts/${{ matrix.target }}/
          fi

          # Include configuration files
          cp package.json artifacts/${{ matrix.target }}/
          cp vite.config.ts artifacts/${{ matrix.target }}/ || true

          # Create deployment package
          cd artifacts/${{ matrix.target }}
          tar -czf ../vb6-web-${{ matrix.target }}-${{ github.sha }}.tar.gz .

      - name: ğŸ“Š Analyze bundle size
        run: |
          npm run analyze || npx vite-bundle-analyzer dist/

      - name: ğŸ” Security scan
        run: |
          npm audit --audit-level=high
          cd server && npm audit --audit-level=high

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: |
            artifacts/${{ matrix.target }}/
            artifacts/vb6-web-${{ matrix.target }}-${{ github.sha }}.tar.gz
          retention-days: 30

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================
  test-integration:
    name: ğŸ”„ Integration Tests
    runs-on: ubuntu-latest
    needs: [build]

    services:
      # Test database for integration tests
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: vb6test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-development
          path: artifacts/

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Setup test database
        run: |
          npm run db:setup:test || echo "Database setup not available"
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/vb6test

      - name: ğŸ§ª Run integration tests
        run: |
          npm run test:integration || npm test -- src/test/integration/
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/vb6test
          TEST_TIMEOUT: 30000

      - name: ğŸ§ª Run E2E tests
        run: |
          npm run test:e2e || echo "E2E tests not available"

      - name: ğŸ“Š Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            coverage/
            test-results/
            screenshots/
          retention-days: 30

  # ============================================================================
  # SECURITY SCANNING
  # ============================================================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”’ Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

      - name: ğŸ” CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: ğŸ›¡ï¸ OWASP Dependency Check
        run: |
          npm install -g @cyclonedx/cyclonedx-npm
          cyclonedx-npm --output-format json --output-file sbom.json
        continue-on-error: true

      - name: ğŸ“Š Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            snyk-report.json
            sbom.json
          retention-days: 90

  # ============================================================================
  # DEPLOYMENT
  # ============================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, test-integration, security]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging

    steps:
      - name: ğŸ“¥ Download production build
        uses: actions/download-artifact@v4
        with:
          name: build-production
          path: build/

      - name: ğŸš€ Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add actual deployment commands here
        env:
          STAGING_API_KEY: ${{ secrets.STAGING_API_KEY }}
          STAGING_URL: ${{ vars.STAGING_URL }}

      - name: ğŸ§ª Run smoke tests
        run: |
          # Basic smoke tests on staging
          curl -f ${{ vars.STAGING_URL }}/health || exit 1
          echo "Staging deployment successful!"

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test-integration, security, benchmark]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.setup.outputs.should-deploy == 'true'
    environment: production

    steps:
      - name: ğŸ“¥ Download production build
        uses: actions/download-artifact@v4
        with:
          name: build-production
          path: build/

      - name: ğŸš€ Deploy to production
        run: |
          echo "Deploying to production environment..."
          # Add actual deployment commands here
        env:
          PRODUCTION_API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
          PRODUCTION_URL: ${{ vars.PRODUCTION_URL }}

      - name: ğŸ§ª Run production smoke tests
        run: |
          curl -f ${{ vars.PRODUCTION_URL }}/health || exit 1
          curl -f ${{ vars.PRODUCTION_URL }}/api/version || exit 1
          echo "Production deployment successful!"

      - name: ğŸ“¢ Create release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: VB6 Web Compiler v${{ github.run_number }}
          body: |
            ## ğŸš€ Release v${{ github.run_number }}

            **Deployed to Production**: ${{ vars.PRODUCTION_URL }}

            ### ğŸ“Š Test Results
            - âœ… Unit Tests: Passed
            - âœ… Integration Tests: Passed  
            - âœ… Security Scan: Passed
            - âœ… Performance Benchmarks: Passed

            ### ğŸ“ˆ Performance Metrics
            See attached benchmark reports for detailed performance analysis.

            ### ğŸ”— Artifacts
            - Production build available in release assets
            - Source maps included for debugging
          draft: false
          prerelease: false

  # ============================================================================
  # NOTIFICATION & CLEANUP
  # ============================================================================
  notify:
    name: ğŸ“¢ Notify & Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always()

    steps:
      - name: ğŸ“¢ Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#vb6-web-builds'
          text: |
            VB6 Web Compiler Build ${{ github.run_number }}
            Status: ${{ job.status }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ§¹ Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Keep only last 10 artifacts per type
            const artifactsByName = {};
            artifacts.forEach(artifact => {
              const baseName = artifact.name.replace(/-\d+$/, '');
              if (!artifactsByName[baseName]) {
                artifactsByName[baseName] = [];
              }
              artifactsByName[baseName].push(artifact);
            });

            for (const [name, arts] of Object.entries(artifactsByName)) {
              if (arts.length > 10) {
                const toDelete = arts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(10);
                for (const artifact of toDelete) {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                }
              }
            }

# ============================================================================
# WORKFLOW CONFIGURATION
# ============================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash
