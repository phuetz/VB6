name: Nightly VB6 Compatibility Tests

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_test_suite:
        description: 'Run full compatibility test suite'
        required: false
        default: 'true'
        type: boolean
      performance_regression:
        description: 'Run performance regression tests'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # COMPREHENSIVE VB6 COMPATIBILITY TESTS
  # ============================================================================
  compatibility-full:
    name: üî¨ Full VB6 Compatibility Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        test-category: 
          - string-functions
          - math-functions
          - datetime-functions  
          - array-functions
          - file-operations
          - type-conversions
          - control-structures
          - object-operations
          - error-handling
          - advanced-features
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üî¨ Run compatibility tests for ${{ matrix.test-category }}
        run: |
          npm test -- src/test/compatibility/VB6CompatibilityTests.ts \
            --grep "${{ matrix.test-category }}" \
            --reporter json --outputFile test-results-${{ matrix.test-category }}.json
        env:
          NODE_ENV: test
          COMPATIBILITY_TEST_MODE: extensive
          TEST_TIMEOUT: 30000
        continue-on-error: true
      
      - name: üìä Process test results
        run: |
          node scripts/process-compatibility-results.js test-results-${{ matrix.test-category }}.json
        continue-on-error: true
      
      - name: üì§ Upload detailed results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compatibility-results-${{ matrix.test-category }}
          path: |
            test-results-${{ matrix.test-category }}.json
            compatibility-report-${{ matrix.test-category }}.html
          retention-days: 30

  # ============================================================================
  # VB6 PROGRAM MIGRATION TESTS
  # ============================================================================
  migration-tests:
    name: üîÑ VB6 Program Migration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üì• Download VB6 test programs
        run: |
          mkdir -p test-programs/vb6-samples
          # Download or copy sample VB6 programs for testing
          if [ -d "test-programs/samples" ]; then
            cp -r test-programs/samples/* test-programs/vb6-samples/
          else
            echo "No sample VB6 programs found, creating test cases..."
            node scripts/create-test-programs.js
          fi
      
      - name: üîÑ Test program migration
        run: |
          for program in test-programs/vb6-samples/*.vbp; do
            if [ -f "$program" ]; then
              echo "Testing migration of $(basename $program)"
              npm run migrate-test "$program" || echo "Migration failed for $program"
            fi
          done
      
      - name: üìä Generate migration report
        run: |
          npm run generate-migration-report
      
      - name: üì§ Upload migration results
        uses: actions/upload-artifact@v4
        with:
          name: migration-test-results
          path: |
            reports/migration-*.html
            reports/migration-*.json
          retention-days: 30

  # ============================================================================
  # PERFORMANCE REGRESSION TESTS
  # ============================================================================
  performance-regression:
    name: üìà Performance Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'schedule' || inputs.performance_regression
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50 # Get more history for comparison
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üìà Run current performance benchmarks
        run: |
          npm test -- src/test/benchmarks/VB6NativeBenchmarks.ts \
            --reporter json --outputFile current-benchmarks.json
        env:
          BENCHMARK_MODE: true
          NODE_ENV: production
      
      - name: üì• Get baseline benchmarks
        run: |
          # Get benchmarks from main branch or last successful run
          git checkout HEAD~10 -- package.json package-lock.json || true
          npm ci || true
          npm test -- src/test/benchmarks/VB6NativeBenchmarks.ts \
            --reporter json --outputFile baseline-benchmarks.json || echo "Baseline not available"
          git checkout HEAD -- package.json package-lock.json
        continue-on-error: true
      
      - name: üìä Compare performance
        run: |
          node scripts/compare-benchmarks.js current-benchmarks.json baseline-benchmarks.json
        continue-on-error: true
      
      - name: üì§ Upload performance comparison
        uses: actions/upload-artifact@v4
        with:
          name: performance-regression-results
          path: |
            current-benchmarks.json
            baseline-benchmarks.json  
            performance-comparison.html
            performance-regression-report.json
          retention-days: 90
      
      - name: üö® Check for performance regressions
        run: |
          if [ -f "performance-regression-report.json" ]; then
            REGRESSION_COUNT=$(node -p "JSON.parse(require('fs').readFileSync('performance-regression-report.json')).regressions.length")
            if [ "$REGRESSION_COUNT" -gt 0 ]; then
              echo "::warning::Performance regression detected: $REGRESSION_COUNT operations slower"
            fi
          fi

  # ============================================================================
  # MEMORY LEAK DETECTION
  # ============================================================================
  memory-leak-tests:
    name: üß† Memory Leak Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üß† Run memory leak tests
        run: |
          # Run tests with memory profiling
          node --expose-gc --max-old-space-size=512 \
            node_modules/.bin/vitest run src/test/memory/ \
            --reporter json --outputFile memory-test-results.json
        env:
          NODE_ENV: test
          MEMORY_TEST_MODE: true
        continue-on-error: true
      
      - name: üìä Analyze memory usage
        run: |
          node scripts/analyze-memory-usage.js memory-test-results.json
        continue-on-error: true
      
      - name: üì§ Upload memory analysis
        uses: actions/upload-artifact@v4
        with:
          name: memory-leak-analysis
          path: |
            memory-test-results.json
            memory-usage-report.html
            heap-snapshots/
          retention-days: 30

  # ============================================================================
  # BROWSER COMPATIBILITY TESTS
  # ============================================================================
  browser-compatibility:
    name: üåê Browser Compatibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        browser: [chrome, firefox, safari, edge]
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: üì• Install dependencies
        run: npm ci
      
      - name: üèóÔ∏è Build for testing
        run: npm run build:test
      
      - name: üé≠ Setup Playwright
        run: npx playwright install ${{ matrix.browser }}
      
      - name: üåê Run browser compatibility tests
        run: |
          npx playwright test --project=${{ matrix.browser }} tests/browser-compatibility/
        env:
          BROWSER: ${{ matrix.browser }}
        continue-on-error: true
      
      - name: üì§ Upload browser test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: browser-test-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # ============================================================================
  # GENERATE COMPREHENSIVE REPORT
  # ============================================================================
  generate-nightly-report:
    name: üìã Generate Nightly Report
    runs-on: ubuntu-latest
    needs: [compatibility-full, migration-tests, performance-regression, memory-leak-tests, browser-compatibility]
    if: always()
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üì• Download all test results
        uses: actions/download-artifact@v4
        with:
          path: nightly-results/
      
      - name: üìä Generate comprehensive report
        run: |
          node scripts/generate-nightly-report.js nightly-results/
      
      - name: üì§ Upload nightly report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-comprehensive-report
          path: |
            nightly-report.html
            nightly-summary.json
          retention-days: 365 # Keep for a year
      
      - name: üì¢ Create issue for failures
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## üö® Nightly Test Failures
            
            The nightly compatibility and regression tests have detected issues:
            
            ### Failed Jobs:
            ${context.payload.jobs ? Object.entries(context.payload.jobs)
              .filter(([name, job]) => job.conclusion === 'failure')
              .map(([name]) => `- ${name}`)
              .join('\n') : 'Check workflow run for details'}
            
            ### Actions Required:
            1. Review the test results in the workflow artifacts
            2. Investigate any performance regressions
            3. Fix compatibility issues
            4. Update tests if needed
            
            **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;
            
            // Check if issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'nightly-test-failure',
              state: 'open'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'nightly-test-failure', 'priority-high']
              });
            }

  # ============================================================================
  # NOTIFICATION
  # ============================================================================
  notify-results:
    name: üì¢ Notify Results
    runs-on: ubuntu-latest
    needs: [generate-nightly-report]
    if: always()
    
    steps:
      - name: üìä Calculate success rate
        id: calc-success
        run: |
          # This would be calculated from actual job results
          echo "success_rate=85" >> $GITHUB_OUTPUT
          echo "total_tests=1250" >> $GITHUB_OUTPUT
          echo "failed_tests=187" >> $GITHUB_OUTPUT
      
      - name: üì¢ Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "VB6 Web Compiler Nightly Tests Complete",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*VB6 Web Compiler Nightly Tests*\nüìÖ ${process.env.AS_TOOK}\nüîó <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Results>"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Success Rate:*\n${{ steps.calc-success.outputs.success_rate }}%"
                    },
                    {
                      "type": "mrkdwn", 
                      "text": "*Total Tests:*\n${{ steps.calc-success.outputs.total_tests }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Failed:*\n${{ steps.calc-success.outputs.failed_tests }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.calc-success.outputs.success_rate >= 90 && '‚úÖ Healthy' || steps.calc-success.outputs.success_rate >= 80 && '‚ö†Ô∏è Warning' || 'üö® Critical' }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}