# Docker Compose pour production avec optimisations
version: '3.8'

services:
  # Service principal VB6 Web IDE (optimisé pour production)
  vb6-ide:
    build:
      context: .
      dockerfile: Dockerfile.prod
      cache_from:
        - vb6-web-ide:cache
    image: vb6-web-ide:${APP_VERSION:-latest}
    container_name: vb6-web-ide-prod
    ports:
      - '${HTTP_PORT:-80}:80'
      - '${HTTPS_PORT:-443}:443'
    environment:
      - NODE_ENV=production
      - VITE_APP_ENV=production
    volumes:
      - vb6_projects:/app/data/projects:rw
      - vb6_cache:/app/data/cache:rw
      - ./config/nginx-prod.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    restart: always
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

  # Load Balancer HAProxy
  haproxy:
    image: haproxy:2.8-alpine
    container_name: vb6-haproxy
    ports:
      - '80:80'
      - '443:443'
      - '8404:8404' # Stats
    volumes:
      - ./config/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./ssl:/etc/ssl:ro
    depends_on:
      - vb6-ide
    restart: always
    networks:
      - vb6-network

  # Redis pour cache et sessions
  redis:
    image: redis:7-alpine
    container_name: vb6-redis
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    restart: always
    networks:
      - vb6-network

  # Service de métriques
  node-exporter:
    image: prom/node-exporter:latest
    container_name: vb6-node-exporter
    ports:
      - '9100:9100'
    restart: always
    networks:
      - vb6-network

  # Logs centralisés
  loki:
    image: grafana/loki:latest
    container_name: vb6-loki
    ports:
      - '3100:3100'
    volumes:
      - ./config/loki.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    restart: always
    networks:
      - vb6-network

  # Promtail pour collecter les logs
  promtail:
    image: grafana/promtail:latest
    container_name: vb6-promtail
    volumes:
      - ./config/promtail.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    restart: always
    networks:
      - vb6-network

networks:
  vb6-network:
    driver: overlay
    attachable: true
    driver_opts:
      encrypted: 'true'

volumes:
  vb6_projects:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/vb6/projects
  vb6_cache:
    driver: local
  redis_data:
    driver: local
  loki_data:
    driver: local
